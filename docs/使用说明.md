# 庆雅神器 · 使用说明

本文件面向研发与测试成员，概述当前 GUI 的关键交互与注意事项，确保在多尺寸、多素材场景下能够稳定复现导出结果。

---

## 1. 主界面速览

| 区域 | 说明 |
| --- | --- |
| 顶部工具栏 | 媒体选择、输出目录、打包/气泡挂件入口 |
| 左侧预览 | 显示经「整体尺寸裁切」后的画布；可拖拽矩形、查看辅助框（封面/红包/挂件/不可编辑框） |
| 右侧面板 | 包含尺寸与矩形参数、反选背景色、素材模块、输出设置等 |
| 底部 | 进度条、开始/停止处理按钮、状态提示 |

### 素材模块

- 面板顶部提供 **「封面/故事/气泡」** 与 **「封面图挂件」** 两个标签按钮  
- 列表会同时展示全部素材，并用 `[主图]` / `[挂件]` 前缀区分  
- 画布上也会同时显示两类素材，但导出时分别作用于不同的内容区域  
- 每个模块最多 5 张素材，超限会禁用「添加素材」按钮

---

## 2. 标准导出流程

1. **选择模式**  
   - 打开应用后先在欢迎页选择「动态视频模式」或「静态图片模式」  
   - 静态模式支持直接载入单帧图片，同时启用气泡挂件功能

2. **整体尺寸裁切（第一步对话框）**  
   - 选择画布尺寸（1053×1746 或 750×1250）  
   - 拖拽/缩放视频至合适位置，保存 `scale` 与 `offset` 参数  
   - 点击「确定」后进入主界面

3. **矩形/尺寸设置**  
   - 预览区直接拖拽，或在右侧输入 X/Y/宽/高  
   - 选择预设尺寸（气泡图 / 封面图 / 封面故事 / 自定义）  
   - 对于封面图，辅助框会自动锁定位置与偏移

4. **素材管理**  
   - 默认在「封面/故事/气泡」模块添加素材，适用于所有常规导出  
   - 每条素材均可设置坐标、缩放、旋转，画布上支持拖拽/缩放手柄操作

5. **输出设置与导出**  
   - 选择输出目录，或沿用自动创建的同名文件夹  
   - 点击「开始处理」，等待进度完成后在弹窗确认

导出结构示例：
```
输出目录/
└── 媒体同名文件夹/
    ├── 气泡图/
    ├── 封面图/
    ├── 封面故事/
    └── 自定义/
        ├── 0001.png
        ├── 0002.png
        └── ...
```

---

## 3. 反选（封面图挂件）流程

1. 在「封面图」尺寸下勾选 **「反选与背景色」**  
2. 系统自动锁定挂件框、红包带开字框、不可编辑框的尺寸与相对位置  
3. **素材作用域规则**  
   - `[主图]` 素材：同时参与封面图、封面故事、气泡图导出  
   - `[挂件]` 素材：仅参与封面图挂件导出（对应 B 区域）  
4. 导出结果拆分为两部分：  
   - **A 部分**（挂件框 - 红包框）：主画面内容 + 所有素材  
   - **B 部分**（红包框 - 不可编辑框）：仅保留挂件素材，并自动合并到最终 PNG  
5. 灰色遮罩仅作用于不可编辑区域，用于预览时提醒；导出结果保持透明

Tips：
- 反选模式下可以在面板内添加最多 4 个自定义背景颜色，提升背景扣除准确度  
- 关闭反选后会保留素材，但导出逻辑恢复为普通裁切

---

## 4. 气泡挂件制作

1. 在「静态图片模式」下点击 **「气泡挂件制作」**  
2. 对话框内加载 720×264 底图（可接受任意 PNG/JPG，程序会等比缩放）  
3. 编辑区划分上下中三个区域，中区禁止放置素材（程序会检测碰撞）  
4. 对话框调用系统文件选择器时，如果用户取消操作，窗口会自动 `raise_()` 并重新获取焦点，避免被主界面遮挡  
5. 支持导出 480×384 RGBA PNG、素材库保存、素材库导入等操作

---

## 5. 常见问题与排查

| 场景 | 处理建议 |
| --- | --- |
| 画布内素材消失 | 检查是否超出画布；素材坐标允许为负数，但导出时会自动裁切，如果完全在外部则不会写入。 |
| 反选导出 B 区域为空 | 确认 `[挂件]` 模块内至少存在一张素材，或素材的 Alpha 通道不为 0。 |
| `@12345.png` 叠加位置异常 | 仅当启用「整体尺寸裁切 + 封面图」时会追加 (48, 96) offset，确保第一步参数已保存。 |
| 打包后资源缺失 | 运行 `python build_exe.py` / `python build_macos_app.py`，脚本已包含 resources 目录与 hook。 |
| 气泡挂件对话框被遮挡 | 取消文件选择后会自动 `activateWindow()`；如仍被遮挡，可在主界面再次点击入口按钮。 |

---

## 6. 小结

- 公共素材与挂件素材 **始终同时预览**，但导出逻辑按作用域区分  
- 反选模式 = 自动生成双环 mask + 背景扣除 + 素材层拆分  
- 气泡挂件编辑器是一个完全独立的流程，输出分辨率固定为 480×384  

如需更深入的架构信息，请结合 `docs/项目结构说明.md` 与 `docs/打包说明.md` 一起阅读。EOF

