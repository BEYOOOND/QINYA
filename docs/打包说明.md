# 庆雅神器 · 打包说明

面向发布与测试同学，说明 Win/mac 双平台的打包步骤、产物位置与常见问题。所有命令均在项目根目录执行。

---

## 1. 打包前准备

1. **Python & 依赖**
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows 用 .venv\\Scripts\\activate
   pip install -r requirements.txt
   pip install pyinstaller==6.5.0
   ```
2. **清理旧产物**
   ```bash
   rm -rf build dist
   ```
3. **资源确认**
   - `resources/12345.png`、`App icon_128x128.ico`、`App icon_128x128.icns` 均存在
   - `庆雅神器.spec` 与 `build_*.py` 未改名

---

## 2. Windows 打包

### 2.1 一键脚本
```bash
python build_exe.py
```
脚本会：
- 自动调用 `pyinstaller`，输出位置 `dist/庆雅神器/【主程序】`
- 复制 `resources/` 目录、hook（cv2/numpy/PyQt5）与 `hook-*.py`
- 写入日志到 `build/` 目录，方便排查

### 2.2 产物与验证
1. 核心文件：`dist/庆雅神器/庆雅神器.exe`
2. 运行一次，确认：
   - `12345.png`、主题图标是否正常加载
   - 选择视频后可导出任意尺寸
3. 如需单文件分发，可在脚本中开启 `--onefile`（默认生成 onedir，利于调试）

---

## 3. macOS 打包

### 3.1 一键脚本
```bash
python build_macos_app.py
```
脚本会：
- 使用 PyInstaller 生成 CLI 版本与 `.app` 目录
- 写入 `Info.plist`、复制 `.icns`、去除 `xattr`
- 自动设置 `CFBundleName=庆雅神器`

### 3.2 验证与分发
1. 产物：
   - `dist/庆雅神器.app`
   - `dist/庆雅神器`（命令行版本）
2. 本地验证：
   ```bash
   open dist/庆雅神器.app
   ```
3. 可选：开发者证书签名与 Gatekeeper 测试
   ```bash
   codesign --deep --force --sign "Developer ID Application: <Your Name>" dist/庆雅神器.app
   spctl --verbose=4 --assess dist/庆雅神器.app
   ```
4. 对外分发建议先压缩：`zip -r 庆雅神器_mac.zip dist/庆雅神器.app`

---

## 4. 自定义/手动打包

若需调整参数，可直接使用 spec 文件：
```bash
pyinstaller 庆雅神器.spec
```
常见参数：
- `--icon=resources/App icon_128x128.ico`
- `--add-data "resources/12345.png;resources"`（Windows 分隔符 `;`，macOS 用 `:`）
- `--clean` 清理缓存

---

## 5. 常见问题

| 问题 | 排查建议 |
| --- | --- |
| 打包后启动闪退 | 检查 `dist/庆雅神器/_internal/` 是否包含 `Qt5/*` 和 `PyQt5/Qt/plugins`；必要时删除 `build/ dist/` 后重试。 |
| 图标未生效 | 确认脚本中引用的 .ico/.icns 路径存在；Windows 上如需资源嵌入，务必保持 64×64+ 尺寸。 |
| macOS Gatekeeper 拒绝 | 运行 `xattr -cr dist/庆雅神器.app` 或执行签名命令后重新分发。 |
| 资源缺失 | 确认新增的 PNG/字体已放入 `resources/`，并在两个 build 脚本的 `datas` 列表中登记。 |
| 体积过大 | `--onefile` 会显著增大体积，可改用默认 onedir，并使用 zip 分发。 |

---

如需 CI/CD 集成或自定义渠道发布，可基于此文档扩展脚本并补充校验步骤。EOF