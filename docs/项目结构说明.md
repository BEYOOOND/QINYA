# 庆雅神器 · 项目结构说明

> 版本：1.4 · 最近更新：2025-11-19

本文梳理代码仓库的主要目录、关键脚本以及常用命令，便于快速定位功能与资源。

---

## 1. 顶层结构

```
项目根目录
├── build/                # PyInstaller 中间文件（自动生成，可清理）
├── dist/                 # 打包产物（.exe / .app / onedir）
├── docs/                 # 文档（本次整理后仅保留核心几篇）
├── resources/            # 图标、挂件素材、主题图片
├── scripts/              # 启动/激活相关脚本
├── build_exe.py          # Windows 一键打包脚本
├── build_macos_app.py    # macOS 一键打包脚本
├── create_icns.py        # 将 ico/png 转换为 icns 的辅助脚本
├── gui.py                # PyQt5 主界面 + 业务逻辑
├── main.py               # 应用入口，加载 GUI
├── ui_components.py      # 自定义控件（折叠面板、帧导航、主题按钮）
├── ui_utils.py           # 主题/字体/DPI 工具
├── video_processor.py    # 视频帧、裁切、透明度、Watermark 计算
├── requirements.txt      # Python 依赖
└── 庆雅神器.spec         # PyInstaller spec，可用于自定义打包
```

---

## 2. 目录详情

### resources/
- `12345.png`：封面图挂件预览附件
- `App icon_128x128.ico/.icns`：打包使用的图标
- `欢迎页照片.png`、`白.png`、`黑.png`：主题/欢迎页素材
- 其他 PNG：主界面按钮、空状态插图

### docs/
- `README.md`：项目概览、功能列表、工作流
- `安装说明.md`：推荐 Python 版本 & 依赖安装指引
- `使用说明.md`：主界面、反选、气泡挂件的操作流程
- `打包说明.md`：Win/mac 打包及常见问题
- `项目结构说明.md`：本文件

### scripts/
- `启动程序.(bat|sh)`：带虚拟环境的启动脚本示例
- `启动激活码管理工具.*`：保留的辅助脚本（如不再需要，可后续移除）

### build_exe.py / build_macos_app.py
- 统一添加 PyQt5/numpy/OpenCV 所需的 hidden imports 与资源
- 自动拷贝 `resources/`、`hook-*.py`
- macOS 版本额外生成 `.app` 并写入 `Info.plist`

### gui.py
- `VideoProcessorGUI`：主窗口，包含尺寸、反选、素材模块逻辑
- `ImageLabel`：可绘制多矩形、展示双模块素材与 `@12345.png`
- `BubblePendantWidget`：气泡挂件编辑对话框
- `ProcessingThread`：导出线程（帧提取、遮罩、合成）

### video_processor.py
- 负责 `VideoProcessor` 类：帧提取、时间裁切、RGBA 合成
- `_build_ring_mask_local()`：反选区域使用的环形 mask
- `add_watermark()`：素材叠加，支持旋转/缩放/预乘 alpha

---

## 3. 常用命令速查

```bash
# 运行应用
python main.py

# Windows 打包（输出 dist/庆雅神器/）
python build_exe.py

# macOS 打包（输出 dist/庆雅神器.app）
python build_macos_app.py

# 清理打包缓存rm -rf build dist
```

---

## 4. 开发注意事项

1. **资源统一**：新增图片/字体务必放入 `resources/` 并同步到打包脚本的 `datas` 列表。
2. **跨平台**：保持路径 `os.path.join`、避免硬编码绝对路径；macOS 打包需准备 `.icns`。 
3. **素材模块**：`self.watermarks` 中的 `scope` 字段用于区分主图/挂件素材，所有导出逻辑依赖该字段。
4. **线程安全**：长耗时操作放入 `ProcessingThread`，通过信号在主线程更新 UI。

如需扩展 CI/CD 或新增目录，请同步更新本文以保证团队共识。EOF